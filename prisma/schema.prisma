generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model accounts {
  id                  String  @id
  user_id             String
  type                String
  provider            String
  provider_account_id String
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?
  users               users   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model audit_logs {
  id          String   @id
  user_id     String
  action      String
  resource    String
  resource_id String
  details     Json?
  ip          String?
  user_agent  String?
  timestamp   DateTime @default(now())
  created_at  DateTime @default(now())
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([resource, resource_id])
  @@index([user_id, timestamp])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model bookings {
  id                    String           @id
  booking_number        String           @unique
  user_id               String
  service_tier_id       String
  status                String           @default("pending")
  payment_status        String           @default("pending")
  total_amount          Decimal          @db.Decimal(12, 2)
  discount_amount       Decimal          @default(0) @db.Decimal(12, 2)
  final_amount          Decimal          @db.Decimal(12, 2)
  currency              String           @default("VND")
  booking_details       Json?
  customer_requirements String?
  start_date            DateTime?
  end_date              DateTime?
  assigned_staff_id     String?
  completion_percentage Int              @default(0)
  customer_rating       Int?
  customer_feedback     String?
  internal_notes        String?
  created_at            DateTime         @default(now())
  updated_at            DateTime
  service_tiers         service_tiers    @relation(fields: [service_tier_id], references: [id])
  users                 users            @relation(fields: [user_id], references: [id])
  communications        communications[]
  leads                 leads?
  payments              payments[]
  service_tasks         service_tasks[]

  @@index([assigned_staff_id, status])
  @@index([payment_status])
  @@index([service_tier_id])
  @@index([status, created_at])
  @@index([user_id, status])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model communications {
  id            String    @id
  user_id       String
  booking_id    String?
  type          String
  channel       String?
  subject       String?
  content       String
  template_id   String?
  template_data Json?
  status        String    @default("pending")
  sent_at       DateTime?
  delivered_at  DateTime?
  read_at       DateTime?
  error_message String?
  created_at    DateTime  @default(now())
  bookings      bookings? @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  users         users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([booking_id])
  @@index([type, status])
  @@index([user_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model file_uploads {
  id            String   @id
  key           String   @unique
  filename      String
  mime_type     String
  size          Int
  folder        String
  is_public     Boolean  @default(false)
  thumbnail_key String?
  metadata      Json?
  created_at    DateTime @default(now())
  updated_at    DateTime
  user_id       String
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([user_id, folder])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model leads {
  id                   String    @id
  email                String?
  phone                String?
  full_name            String?
  service_interest     String?
  source               String?
  utm_source           String?
  utm_medium           String?
  utm_campaign         String?
  lead_score           Int       @default(0)
  status               String    @default("new")
  assigned_to          String?
  notes                String?
  converted_at         DateTime?
  converted_booking_id String?   @unique
  created_at           DateTime  @default(now())
  updated_at           DateTime
  users                users?    @relation(fields: [assigned_to], references: [id])
  bookings             bookings? @relation(fields: [converted_booking_id], references: [id])

  @@index([assigned_to, status])
  @@index([email])
  @@index([source])
  @@index([status, created_at])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model password_history {
  id            String   @id
  user_id       String
  password_hash String
  created_at    DateTime @default(now())
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model password_reset_tokens {
  id         String   @id
  token      String   @unique
  user_id    String
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model payments {
  id                     String    @id
  booking_id             String
  payment_number         String    @unique
  amount                 Decimal   @db.Decimal(12, 2)
  currency               String    @default("VND")
  payment_method         String
  payment_gateway        String
  gateway_transaction_id String?
  gateway_order_id       String?
  status                 String    @default("pending")
  failure_reason         String?
  gateway_response       Json?
  paid_at                DateTime?
  refunded_at            DateTime?
  refund_amount          Decimal   @default(0) @db.Decimal(12, 2)
  refund_reason          String?
  created_at             DateTime  @default(now())
  updated_at             DateTime
  bookings               bookings  @relation(fields: [booking_id], references: [id])

  @@index([booking_id])
  @@index([created_at])
  @@index([payment_gateway, status])
  @@index([status])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model security_logs {
  id         String   @id
  event      String
  user_id    String?
  ip         String?
  user_agent String?
  url        String?
  data       Json?
  timestamp  DateTime @default(now())
  created_at DateTime @default(now())

  @@index([event, timestamp])
  @@index([user_id, timestamp])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model service_tasks {
  id           String    @id
  booking_id   String
  type         String
  title        String
  description  String?
  priority     String    @default("medium")
  status       String    @default("pending")
  assigned_to  String?
  due_date     DateTime?
  completed_at DateTime?
  metadata     Json?
  created_at   DateTime  @default(now())
  updated_at   DateTime
  users        users?    @relation(fields: [assigned_to], references: [id])
  bookings     bookings  @relation(fields: [booking_id], references: [id], onDelete: Cascade)

  @@index([assigned_to, status])
  @@index([booking_id, status])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model service_tiers {
  id                String     @id
  service_id        String
  name              String
  slug              String
  price             Decimal    @db.Decimal(12, 2)
  original_price    Decimal?   @db.Decimal(12, 2)
  features          Json
  limitations       Json?
  is_popular        Boolean    @default(false)
  is_available      Boolean    @default(true)
  max_customers     Int?
  current_customers Int        @default(0)
  sort_order        Int        @default(0)
  metadata          Json?
  created_at        DateTime   @default(now())
  updated_at        DateTime
  bookings          bookings[]
  services          services   @relation(fields: [service_id], references: [id], onDelete: Cascade)

  @@unique([service_id, slug])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model services {
  id                String          @id
  name              String
  slug              String          @unique
  description       String?
  short_description String?
  base_price        Decimal         @db.Decimal(12, 2)
  currency          String          @default("VND")
  category          String?
  is_active         Boolean         @default(true)
  is_featured       Boolean         @default(false)
  sort_order        Int             @default(0)
  metadata          Json?
  created_at        DateTime        @default(now())
  updated_at        DateTime
  service_tiers     service_tiers[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model sessions {
  id            String   @id
  session_token String   @unique
  user_id       String
  expires       DateTime
  users         users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model staff {
  id              String    @id
  user_id         String    @unique
  role            String
  permissions     Json?
  specializations Json?
  is_active       Boolean   @default(true)
  hire_date       DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime
  users           users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model system_logs {
  id          String   @id
  level       String
  message     String
  service     String
  environment String
  context     Json?
  error       Json?
  timestamp   DateTime @default(now())
  created_at  DateTime @default(now())

  @@index([level, timestamp])
  @@index([service, timestamp])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model two_factor_auth {
  id                    String   @id
  user_id               String   @unique
  secret                String
  enabled               Boolean  @default(false)
  backup_codes          String[]
  last_used_backup_code String?
  created_at            DateTime @default(now())
  updated_at            DateTime
  users                 users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model users {
  id                    String                  @id
  email                 String                  @unique
  password              String
  phone                 String?
  full_name             String
  discord_username      String?
  discord_id            String?
  rok_player_id         String?
  rok_kingdom           String?
  rok_power             BigInt?
  preferred_language    String                  @default("vi")
  timezone              String                  @default("Asia/Ho_Chi_Minh")
  status                String                  @default("active")
  email_verified        DateTime?
  last_login            DateTime?
  created_at            DateTime                @default(now())
  updated_at            DateTime
  image                 String?
  accounts              accounts[]
  audit_logs            audit_logs[]
  bookings              bookings[]
  communications        communications[]
  file_uploads          file_uploads[]
  leads                 leads[]
  password_history      password_history[]
  password_reset_tokens password_reset_tokens[]
  service_tasks         service_tasks[]
  sessions              sessions[]
  staff                 staff?
  two_factor_auth       two_factor_auth?
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model webhook_events {
  id              String    @id
  provider        String
  event_type      String
  event_id        String    @unique
  payload         Json
  status          String    @default("pending")
  attempts        Int       @default(0)
  last_attempt_at DateTime?
  next_retry_at   DateTime?
  error_message   String?
  processed_at    DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime

  @@index([event_id])
  @@index([next_retry_at])
  @@index([provider, status])
}
