// Email utility functions for Rise of Kingdoms Services

import { getLogger } from '@/lib/monitoring/logger'

export interface EmailOptions {
  to: string
  subject: string
  html: string
  text?: string
}

import { Resend } from 'resend'

// Initialize Resend only if API key is present to avoid build errors
const resend = process.env.RESEND_API_KEY ? new Resend(process.env.RESEND_API_KEY) : null

// Simple email sender (in production, you'd use services like SendGrid, Resend, etc.)
export async function sendEmail(options: EmailOptions): Promise<boolean> {
  try {
    // In development without API key, just log the email
    if (process.env.NODE_ENV === 'development' && !process.env.RESEND_API_KEY) {
      getLogger().debug('ğŸ“§ Email would be sent (Mock)', {
        to: options.to,
        subject: options.subject,
        preview: options.text?.substring(0, 100) || options.html.substring(0, 100)
      })
      return true
    }

    if (!resend) {
      getLogger().warn('Resend client not initialized (missing API key). Email sending skipped.')
      return true
    }

    const { data, error } = await resend.emails.send({
      from: process.env.EMAIL_FROM ?? 'RoK Services <onboarding@resend.dev>',
      to: options.to,
      subject: options.subject,
      html: options.html,
      text: options.text
    })

    if (error) {
      getLogger().error('Resend API Error', new Error(error.message), {
        error: JSON.stringify(error)
      })
      return false
    }

    getLogger().info(`Email sent successfully to ${options.to} (ID: ${data?.id})`)
    return true
  } catch (error) {
    getLogger().error(
      'Email sending failed',
      error instanceof Error ? error : new Error(String(error)),
      {
        to: options.to,
        subject: options.subject
      }
    )
    return false
  }
}

// Welcome email template
export async function sendWelcomeEmail(email: string, full_name: string): Promise<boolean> {
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>ChÃ o má»«ng Ä‘áº¿n vá»›i RoK Services</title>
      <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          line-height: 1.6;
          color: #333;
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
        }
        .header {
          background: linear-gradient(135deg, #f59e0b, #d97706);
          color: white;
          padding: 30px 20px;
          text-align: center;
          border-radius: 10px 10px 0 0;
        }
        .content {
          background: #f8fafc;
          padding: 30px 20px;
          border-radius: 0 0 10px 10px;
        }
        .button {
          display: inline-block;
          background: #f59e0b;
          color: white;
          padding: 12px 24px;
          text-decoration: none;
          border-radius: 8px;
          font-weight: bold;
          margin: 20px 0;
        }
        .features {
          background: white;
          padding: 20px;
          border-radius: 8px;
          margin: 20px 0;
        }
        .feature-item {
          display: flex;
          align-items: center;
          margin: 10px 0;
        }
        .feature-icon {
          margin-right: 10px;
          font-size: 18px;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>ğŸ° ChÃ o má»«ng Ä‘áº¿n vá»›i RoK Services!</h1>
        <p>Xin chÃ o ${full_name}, cáº£m Æ¡n báº¡n Ä‘Ã£ tham gia cá»™ng Ä‘á»“ng Rise of Kingdoms chuyÃªn nghiá»‡p!</p>
      </div>
      
      <div class="content">
        <h2>ğŸ‰ TÃ i khoáº£n cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng!</h2>
        
        <p>ChÃºc má»«ng báº¡n Ä‘Ã£ trá»Ÿ thÃ nh thÃ nh viÃªn cá»§a RoK Services - ná»n táº£ng dá»‹ch vá»¥ Rise of Kingdoms hÃ ng Ä‘áº§u Viá»‡t Nam.</p>
        
        <div class="features">
          <h3>ğŸ’ Nhá»¯ng gÃ¬ báº¡n cÃ³ thá»ƒ lÃ m ngay bÃ¢y giá»:</h3>
          
          <div class="feature-item">
            <span class="feature-icon">ğŸ“š</span>
            <span>Truy cáº­p thÆ° viá»‡n hÆ°á»›ng dáº«n miá»…n phÃ­</span>
          </div>
          
          <div class="feature-item">
            <span class="feature-icon">ğŸ†</span>
            <span>Äáº·t dá»‹ch vá»¥ tÆ° váº¥n chiáº¿n thuáº­t chuyÃªn nghiá»‡p</span>
          </div>
          
          <div class="feature-item">
            <span class="feature-icon">ğŸ‘¥</span>
            <span>Tham gia cá»™ng Ä‘á»“ng Discord VIP</span>
          </div>
          
          <div class="feature-item">
            <span class="feature-icon">âš”ï¸</span>
            <span>Sá»­ dá»¥ng cÃ´ng cá»¥ quáº£n lÃ½ alliance</span>
          </div>
        </div>
        
        <p style="text-align: center;">
          <a href="${process.env.NEXTAUTH_URL ?? 'https://rokdbot.com'}/dashboard" class="button">
            ğŸš€ KhÃ¡m phÃ¡ Dashboard
          </a>
        </p>
        
        <hr style="margin: 30px 0; border: none; border-top: 1px solid #e2e8f0;">
        
        <h3>ğŸ”¥ Æ¯u Ä‘Ã£i Ä‘áº·c biá»‡t cho thÃ nh viÃªn má»›i:</h3>
        <ul>
          <li><strong>Giáº£m 20%</strong> dá»‹ch vá»¥ tÆ° váº¥n Ä‘áº§u tiÃªn</li>
          <li><strong>Miá»…n phÃ­</strong> phÃ¢n tÃ­ch kingdom vÃ  alliance</li>
          <li><strong>Truy cáº­p VIP</strong> group Discord trong 7 ngÃ y</li>
        </ul>
        
        <p><strong>MÃ£ giáº£m giÃ¡:</strong> <code style="background: #fef3c7; padding: 4px 8px; border-radius: 4px;">WELCOME20</code></p>
        
        <hr style="margin: 30px 0; border: none; border-top: 1px solid #e2e8f0;">
        
        <p><strong>Cáº§n há»— trá»£?</strong></p>
        <ul>
          <li>ğŸ“§ Email: <a href="mailto:support@rokdbot.com">support@rokdbot.com</a></li>
          <li>ğŸ’¬ Discord: <a href="https://discord.gg/rokservices">discord.gg/rokservices</a></li>
          <li>ğŸ“± Website: <a href="${process.env.NEXTAUTH_URL ?? 'https://rokdbot.com'}">${process.env.NEXTAUTH_URL ?? 'rokdbot.com'}</a></li>
        </ul>
        
        <p style="margin-top: 40px; font-size: 14px; color: #64748b;">
          TrÃ¢n trá»ng,<br>
          <strong>Äá»™i ngÅ© RoK Services</strong><br>
          <em>"Your Rise of Kingdoms Success Partner"</em>
        </p>
      </div>
    </body>
    </html>
  `

  const textContent = `
ChÃ o má»«ng Ä‘áº¿n vá»›i RoK Services!

Xin chÃ o ${full_name},

Cáº£m Æ¡n báº¡n Ä‘Ã£ tham gia cá»™ng Ä‘á»“ng Rise of Kingdoms chuyÃªn nghiá»‡p!

TÃ i khoáº£n cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng. BÃ¢y giá» báº¡n cÃ³ thá»ƒ:

â€¢ Truy cáº­p thÆ° viá»‡n hÆ°á»›ng dáº«n miá»…n phÃ­
â€¢ Äáº·t dá»‹ch vá»¥ tÆ° váº¥n chiáº¿n thuáº­t chuyÃªn nghiá»‡p  
â€¢ Tham gia cá»™ng Ä‘á»“ng Discord VIP
â€¢ Sá»­ dá»¥ng cÃ´ng cá»¥ quáº£n lÃ½ alliance

Æ¯u Ä‘Ã£i Ä‘áº·c biá»‡t cho thÃ nh viÃªn má»›i:
- Giáº£m 20% dá»‹ch vá»¥ tÆ° váº¥n Ä‘áº§u tiÃªn
- Miá»…n phÃ­ phÃ¢n tÃ­ch kingdom vÃ  alliance
- Truy cáº­p VIP group Discord trong 7 ngÃ y

MÃ£ giáº£m giÃ¡: WELCOME20

KhÃ¡m phÃ¡ Dashboard: ${process.env.NEXTAUTH_URL ?? 'https://rokdbot.com'}/dashboard

Cáº§n há»— trá»£?
- Email: support@rokdbot.com
- Discord: discord.gg/rokservices
- Website: ${process.env.NEXTAUTH_URL ?? 'rokdbot.com'}

TrÃ¢n trá»ng,
Äá»™i ngÅ© RoK Services
"Your Rise of Kingdoms Success Partner"
  `

  return sendEmail({
    to: email,
    subject: 'ğŸ° ChÃ o má»«ng Ä‘áº¿n vá»›i RoK Services - TÃ i khoáº£n Ä‘Ã£ Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng!',
    html: htmlContent,
    text: textContent
  })
}

// Password reset email
export async function sendPasswordResetEmail(email: string, resetToken: string): Promise<boolean> {
  const resetUrl = `${process.env.NEXTAUTH_URL ?? 'https://rokdbot.com'}/auth/reset-password?token=${resetToken}`

  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>Äáº·t láº¡i máº­t kháº©u - RoK Services</title>
      <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          line-height: 1.6;
          color: #333;
          max-width: 600px;
          margin: 0 auto;
          padding: 20px;
        }
        .header {
          background: linear-gradient(135deg, #3b82f6, #1d4ed8);
          color: white;
          padding: 30px 20px;
          text-align: center;
          border-radius: 10px 10px 0 0;
        }
        .content {
          background: #f8fafc;
          padding: 30px 20px;
          border-radius: 0 0 10px 10px;
        }
        .button {
          display: inline-block;
          background: #3b82f6;
          color: white;
          padding: 15px 30px;
          text-decoration: none;
          border-radius: 8px;
          font-weight: bold;
          margin: 20px 0;
        }
        .warning {
          background: #fef3c7;
          border: 1px solid #f59e0b;
          padding: 15px;
          border-radius: 8px;
          margin: 20px 0;
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>ğŸ”’ Äáº·t láº¡i máº­t kháº©u</h1>
        <p>YÃªu cáº§u thay Ä‘á»•i máº­t kháº©u cho tÃ i khoáº£n RoK Services</p>
      </div>
      
      <div class="content">
        <p>ChÃºng tÃ´i nháº­n Ä‘Æ°á»£c yÃªu cáº§u Ä‘áº·t láº¡i máº­t kháº©u cho tÃ i khoáº£n cÃ³ email <strong>${email}</strong>.</p>
        
        <p>Náº¿u báº¡n Ä‘Ã£ yÃªu cáº§u Ä‘iá»u nÃ y, hÃ£y click vÃ o nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ Ä‘áº·t máº­t kháº©u má»›i:</p>
        
        <p style="text-align: center;">
          <a href="${resetUrl}" class="button">
            ğŸ”‘ Äáº·t láº¡i máº­t kháº©u
          </a>
        </p>
        
        <div class="warning">
          <strong>âš ï¸ LÆ°u Ã½ quan trá»ng:</strong>
          <ul>
            <li>Link nÃ y sáº½ háº¿t háº¡n sau <strong>1 giá»</strong></li>
            <li>Chá»‰ cÃ³ thá»ƒ sá»­ dá»¥ng <strong>má»™t láº§n</strong></li>  
            <li>Náº¿u báº¡n khÃ´ng yÃªu cáº§u Ä‘áº·t láº¡i máº­t kháº©u, hÃ£y bá» qua email nÃ y</li>
          </ul>
        </div>
        
        <p style="font-size: 14px; color: #64748b;">
          Náº¿u nÃºt khÃ´ng hoáº¡t Ä‘á»™ng, copy vÃ  paste link sau vÃ o trÃ¬nh duyá»‡t:<br>
          <a href="${resetUrl}">${resetUrl}</a>
        </p>
        
        <hr style="margin: 30px 0; border: none; border-top: 1px solid #e2e8f0;">
        
        <p style="font-size: 14px; color: #64748b;">
          Cáº§n há»— trá»£? LiÃªn há»‡ chÃºng tÃ´i:<br>
          ğŸ“§ <a href="mailto:support@rokdbot.com">support@rokdbot.com</a><br>
          ğŸ’¬ <a href="https://discord.gg/rokservices">Discord Support</a>
        </p>
      </div>
    </body>
    </html>
  `

  const textContent = `
Äáº·t láº¡i máº­t kháº©u - RoK Services

ChÃºng tÃ´i nháº­n Ä‘Æ°á»£c yÃªu cáº§u Ä‘áº·t láº¡i máº­t kháº©u cho tÃ i khoáº£n ${email}.

Náº¿u báº¡n Ä‘Ã£ yÃªu cáº§u Ä‘iá»u nÃ y, truy cáº­p link sau Ä‘á»ƒ Ä‘áº·t máº­t kháº©u má»›i:
${resetUrl}

âš ï¸ LÆ°u Ã½ quan trá»ng:
- Link nÃ y sáº½ háº¿t háº¡n sau 1 giá»
- Chá»‰ cÃ³ thá»ƒ sá»­ dá»¥ng má»™t láº§n
- Náº¿u báº¡n khÃ´ng yÃªu cáº§u Ä‘áº·t láº¡i máº­t kháº©u, hÃ£y bá» qua email nÃ y

Cáº§n há»— trá»£?
Email: support@rokdbot.com
Discord: discord.gg/rokservices

TrÃ¢n trá»ng,
Äá»™i ngÅ© RoK Services
  `

  return sendEmail({
    to: email,
    subject: 'ğŸ”’ Äáº·t láº¡i máº­t kháº©u - RoK Services',
    html: htmlContent,
    text: textContent
  })
}

// Account created email with password
export async function sendAccountCreatedEmail(
  email: string,
  full_name: string,
  password: string
): Promise<boolean> {
  const loginUrl = `${process.env.NEXTAUTH_URL ?? 'https://rokdbot.com'}/auth/signin`

  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <title>TÃ i khoáº£n má»›i - RoK Services</title>
      <style>
        body { font-family: sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #f59e0b; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; border-radius: 0 0 8px 8px; }
        .credentials { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin: 20px 0; }
        .button { display: inline-block; background: #f59e0b; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>ChÃ o má»«ng Ä‘áº¿n vá»›i RoK Services!</h1>
        </div>
        <div class="content">
          <p>Xin chÃ o <strong>${full_name}</strong>,</p>
          <p>TÃ i khoáº£n cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c táº¡o tá»± Ä‘á»™ng khi báº¡n Ä‘áº·t dá»‹ch vá»¥. DÆ°á»›i Ä‘Ã¢y lÃ  thÃ´ng tin Ä‘Äƒng nháº­p cá»§a báº¡n:</p>
          
          <div class="credentials">
            <p><strong>Email:</strong> ${email}</p>
            <p><strong>Máº­t kháº©u:</strong> <code>${password}</code></p>
          </div>

          <p>Vui lÃ²ng Ä‘Äƒng nháº­p vÃ  Ä‘á»•i máº­t kháº©u ngay sau khi truy cáº­p.</p>
          
          <p style="text-align: center;">
            <a href="${loginUrl}" class="button">ÄÄƒng nháº­p ngay</a>
          </p>
        </div>
      </div>
    </body>
    </html>
  `

  return sendEmail({
    to: email,
    subject: 'ğŸ” ThÃ´ng tin tÃ i khoáº£n RoK Services cá»§a báº¡n',
    html: htmlContent,
    text: `Xin chÃ o ${full_name}, tÃ i khoáº£n cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c táº¡o. Email: ${email}, Máº­t kháº©u: ${password}. ÄÄƒng nháº­p táº¡i: ${loginUrl}`
  })
}

// Booking received email
export async function sendBookingReceivedEmail(
  email: string,
  full_name: string,
  booking_number: string,
  serviceName: string
): Promise<boolean> {
  const _paymentUrl = `${process.env.NEXTAUTH_URL ?? 'https://rokdbot.com'}/booking` // Ideally link to specific booking if possible

  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #3b82f6; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; border-radius: 0 0 8px 8px; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>ÄÃ£ nháº­n yÃªu cáº§u Ä‘áº·t lá»‹ch</h1>
        </div>
        <div class="content">
          <p>Xin chÃ o <strong>${full_name}</strong>,</p>
          <p>ChÃºng tÃ´i Ä‘Ã£ nháº­n Ä‘Æ°á»£c yÃªu cáº§u Ä‘áº·t lá»‹ch <strong>${serviceName}</strong> cá»§a báº¡n.</p>
          <p>MÃ£ Ä‘Æ¡n hÃ ng: <strong>${booking_number}</strong></p>
          <p>Vui lÃ²ng hoÃ n táº¥t thanh toÃ¡n Ä‘á»ƒ kÃ­ch hoáº¡t dá»‹ch vá»¥.</p>
        </div>
      </div>
    </body>
    </html>
  `

  return sendEmail({
    to: email,
    subject: `ğŸ“… XÃ¡c nháº­n yÃªu cáº§u Ä‘áº·t lá»‹ch #${booking_number}`,
    html: htmlContent,
    text: `Xin chÃ o ${full_name}, chÃºng tÃ´i Ä‘Ã£ nháº­n Ä‘Æ°á»£c yÃªu cáº§u Ä‘áº·t lá»‹ch ${serviceName} (MÃ£: ${booking_number}). Vui lÃ²ng hoÃ n táº¥t thanh toÃ¡n.`
  })
}

// Order confirmation email (Updated)
export async function sendOrderConfirmationEmail(
  email: string,
  full_name: string,
  orderDetails: {
    orderNumber: string
    serviceName: string
    amount: number
    currency: string
    payment_method?: string
  }
): Promise<boolean> {
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: #10b981; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
        .content { background: #f9fafb; padding: 20px; border: 1px solid #e5e7eb; border-radius: 0 0 8px 8px; }
        .details { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin: 20px 0; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>Thanh toÃ¡n thÃ nh cÃ´ng!</h1>
        </div>
        <div class="content">
          <p>Xin chÃ o <strong>${full_name}</strong>,</p>
          <p>Cáº£m Æ¡n báº¡n Ä‘Ã£ thanh toÃ¡n. Dá»‹ch vá»¥ cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c kÃ­ch hoáº¡t.</p>
          
          <div class="details">
            <p><strong>MÃ£ Ä‘Æ¡n hÃ ng:</strong> ${orderDetails.orderNumber}</p>
            <p><strong>Dá»‹ch vá»¥:</strong> ${orderDetails.serviceName}</p>
            <p><strong>ThÃ nh tiá»n:</strong> ${orderDetails.amount.toLocaleString()} ${orderDetails.currency}</p>
            <p><strong>PhÆ°Æ¡ng thá»©c:</strong> ${orderDetails.payment_method ?? 'N/A'}</p>
          </div>

          <p>Äá»™i ngÅ© cá»§a chÃºng tÃ´i sáº½ liÃªn há»‡ vá»›i báº¡n sá»›m nháº¥t cÃ³ thá»ƒ.</p>
        </div>
      </div>
    </body>
    </html>
  `

  return sendEmail({
    to: email,
    subject: `âœ… Thanh toÃ¡n thÃ nh cÃ´ng #${orderDetails.orderNumber}`,
    html: htmlContent,
    text: `Xin chÃ o ${full_name}, thanh toÃ¡n cho Ä‘Æ¡n hÃ ng #${orderDetails.orderNumber} Ä‘Ã£ thÃ nh cÃ´ng. Cáº£m Æ¡n báº¡n Ä‘Ã£ sá»­ dá»¥ng dá»‹ch vá»¥.`
  })
}
